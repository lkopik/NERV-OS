#!/bin/bash

# –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤–∞
set -e

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≤—ã–≤–æ–¥–∞
info() { echo -e "${BLUE}‚ÑπÔ∏è  $1${NC}"; }
success() { echo -e "${GREEN}‚úÖ $1${NC}"; }
warning() { echo -e "${YELLOW}‚ö†Ô∏è  $1${NC}"; }
error() { echo -e "${RED}‚ùå $1${NC}"; }

# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
BACKUP_DIR="/tmp/distro_backup_$(date +%Y%m%d_%H%M%S)"
CURRENT_DISTRO=""
DETECTED_FILES=()

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â–∏–π –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤
detect_distro() {
    if [ -f /etc/os-release ]; then
        CURRENT_DISTRO=$(source /etc/os-release; echo $NAME)
    elif [ -f /etc/lsb-release ]; then
        CURRENT_DISTRO=$(source /etc/lsb-release; echo $DISTRIB_ID)
    else
        CURRENT_DISTRO="Unknown"
    fi
}

# –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ —Ñ–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤–µ
find_distro_files() {
    info "–ü–æ–∏—Å–∫ —Ñ–∞–π–ª–æ–≤ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤–µ..."
    
    local files=(
        "/etc/os-release"
        "/etc/lsb-release" 
        "/etc/issue"
        "/etc/issue.net"
        "/etc/debian_version"
        "/etc/redhat-release"
        "/etc/centos-release"
        "/etc/fedora-release"
        "/etc/SuSE-release"
        "/etc/arch-release"
        "/etc/alpine-release"
    )
    
    for file in "${files[@]}"; do
        if [ -f "$file" ]; then
            DETECTED_FILES+=("$file")
            info "–ù–∞–π–¥–µ–Ω: $file"
        fi
    done
    
    if [ ${#DETECTED_FILES[@]} -eq 0 ]; then
        error "–ù–µ –Ω–∞–π–¥–µ–Ω—ã —Ñ–∞–π–ª—ã —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤–µ!"
        exit 1
    fi
}

# –°–æ–∑–¥–∞–µ–º –±—ç–∫–∞–ø—ã
create_backups() {
    info "–°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–æ–≤..."
    mkdir -p "$BACKUP_DIR"
    
    for file in "${DETECTED_FILES[@]}"; do
        if [ -f "$file" ]; then
            cp "$file" "$BACKUP_DIR/"
            success "–ë—ç–∫–∞–ø —Å–æ–∑–¥–∞–Ω: $file"
        fi
    done
    
    # –¢–∞–∫–∂–µ –±—ç–∫–∞–ø–∏–º —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
    local extra_files=(
        "/etc/motd"
        "/etc/dynamic-motd"
    )
    
    for file in "${extra_files[@]}"; do
        if [ -f "$file" ]; then
            cp "$file" "$BACKUP_DIR/" 2>/dev/null || true
        fi
    done
}

# –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫–∞—Ç–∞
rollback() {
    error "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞! –û—Ç–∫–∞—Ç—ã–≤–∞—é –∏–∑–º–µ–Ω–µ–Ω–∏—è..."
    if [ -d "$BACKUP_DIR" ]; then
        for file in "${DETECTED_FILES[@]}"; do
            local backup_file="$BACKUP_DIR/$(basename "$file")"
            if [ -f "$backup_file" ]; then
                cp "$backup_file" "$file"
                info "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: $file"
            fi
        done
        success "–û—Ç–∫–∞—Ç –∑–∞–≤–µ—Ä—à–µ–Ω"
    else
        error "–ë—ç–∫–∞–ø—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, –æ—Ç–∫–∞—Ç –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω"
    fi
    exit 1
}

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
trap rollback ERR

# –ü–æ–ª—É—á–∞–µ–º –Ω–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
get_user_input() {
    echo
    info "–¢–µ–∫—É—â–∏–π –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤: $CURRENT_DISTRO"
    echo
    warning "–í–ù–ò–ú–ê–ù–ò–ï: –≠—Ç–æ –∏–∑–º–µ–Ω–∏—Ç —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Ñ–∞–π–ª—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –Ω–∞ —Å–≤–æ–π —Å—Ç—Ä–∞—Ö –∏ —Ä–∏—Å–∫!"
    echo
    
    read -p "–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä–æ—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ (NAME) [$CURRENT_DISTRO]: " NEW_NAME
    NEW_NAME=${NEW_NAME:-"$CURRENT_DISTRO"}
    
    read -p "–í–≤–µ–¥–∏—Ç–µ –ø–æ–ª–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ (PRETTY_NAME) [$NEW_NAME]: " NEW_PRETTY_NAME
    NEW_PRETTY_NAME=${NEW_PRETTY_NAME:-"$NEW_NAME"}
    
    # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º ID –Ω–∞ –æ—Å–Ω–æ–≤–µ NAME
    NEW_ID=$(echo "$NEW_NAME" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]//g')
    if [ -z "$NEW_ID" ]; then
        NEW_ID="custom"
    fi
    
    read -p "–í–≤–µ–¥–∏—Ç–µ ID (–ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã, –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤) [$NEW_ID]: " input_id
    NEW_ID=${input_id:-$NEW_ID}
    
    # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –≤–µ—Ä—Å–∏—é –µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ
    CURRENT_VERSION=""
    if [ -f /etc/os-release ]; then
        CURRENT_VERSION=$(source /etc/os-release; echo $VERSION_ID)
    fi
    CURRENT_VERSION=${CURRENT_VERSION:-"1.0"}
    
    read -p "–í–≤–µ–¥–∏—Ç–µ –≤–µ—Ä—Å–∏—é [$CURRENT_VERSION]: " NEW_VERSION
    NEW_VERSION=${NEW_VERSION:-"$CURRENT_VERSION"}
    
    echo
    info "–ë—É–¥—É—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:"
    echo "  NAME: $NEW_NAME"
    echo "  PRETTY_NAME: $NEW_PRETTY_NAME" 
    echo "  ID: $NEW_ID"
    echo "  VERSION: $NEW_VERSION"
    echo
}

# –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
confirm_changes() {
    read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å? (y/N): " confirm
    if [[ ! $confirm =~ ^[Yy]$ ]]; then
        info "–û—Ç–º–µ–Ω–∞."
        exit 0
    fi
}

# –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤
apply_changes() {
    info "–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π..."
    
    # 1. /etc/os-release (–≥–ª–∞–≤–Ω—ã–π —Ñ–∞–π–ª)
    if [ -f "/etc/os-release" ]; then
        info "–û–±–Ω–æ–≤–ª—è—é /etc/os-release..."
        
        # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
        TEMP_FILE=$(mktemp)
        
        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø–æ—Å—Ç—Ä–æ—á–Ω–æ, —Å–æ—Ö—Ä–∞–Ω—è—è —Å—Ç—Ä—É–∫—Ç—É—Ä—É
        while IFS= read -r line; do
            case $line in
                NAME=*)
                    echo "NAME=\"$NEW_NAME\"" >> "$TEMP_FILE"
                    ;;
                PRETTY_NAME=*)
                    echo "PRETTY_NAME=\"$NEW_PRETTY_NAME\"" >> "$TEMP_FILE"
                    ;;
                ID=*)
                    echo "ID=$NEW_ID" >> "$TEMP_FILE"
                    ;;
                VERSION_ID=*)
                    echo "VERSION_ID=\"$NEW_VERSION\"" >> "$TEMP_FILE"
                    ;;
                *)
                    echo "$line" >> "$TEMP_FILE"
                    ;;
            esac
        done < "/etc/os-release"
        
        # –ï—Å–ª–∏ –∫–∞–∫–∏—Ö-—Ç–æ –ø–æ–ª–µ–π –Ω–µ –±—ã–ª–æ, –¥–æ–±–∞–≤–ª—è–µ–º –∏—Ö
        if ! grep -q "^NAME=" "$TEMP_FILE"; then
            echo "NAME=\"$NEW_NAME\"" >> "$TEMP_FILE"
        fi
        if ! grep -q "^PRETTY_NAME=" "$TEMP_FILE"; then
            echo "PRETTY_NAME=\"$NEW_PRETTY_NAME\"" >> "$TEMP_FILE"
        fi
        if ! grep -q "^ID=" "$TEMP_FILE"; then
            echo "ID=$NEW_ID" >> "$TEMP_FILE"
        fi
        
        sudo cp "$TEMP_FILE" "/etc/os-release"
        sudo chmod 644 "/etc/os-release"
        rm -f "$TEMP_FILE"
        
        success "–û–±–Ω–æ–≤–ª–µ–Ω /etc/os-release"
    fi
    
    # 2. /etc/lsb-release
    if [ -f "/etc/lsb-release" ]; then
        info "–û–±–Ω–æ–≤–ª—è—é /etc/lsb-release..."
        sudo tee "/etc/lsb-release" > /dev/null << EOF
DISTRIB_ID=$NEW_NAME
DISTRIB_RELEASE=$NEW_VERSION
DISTRIB_CODENAME=$NEW_ID
DISTRIB_DESCRIPTION="$NEW_PRETTY_NAME"
EOF
        success "–û–±–Ω–æ–≤–ª–µ–Ω /etc/lsb-release"
    fi
    
    # 3. –§–∞–π–ª—ã issue
    for issue_file in "/etc/issue" "/etc/issue.net"; do
        if [ -f "$issue_file" ]; then
            info "–û–±–Ω–æ–≤–ª—è—é $issue_file..."
            echo "$NEW_PRETTY_NAME \\n \\l" | sudo tee "$issue_file" > /dev/null
            success "–û–±–Ω–æ–≤–ª–µ–Ω $issue_file"
        fi
    done
    
    # 4. –î–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Ñ–∞–π–ª—ã
    if [ -f "/etc/redhat-release" ] || [ -f "/etc/centos-release" ] || [ -f "/etc/fedora-release" ]; then
        info "–û–±–Ω–æ–≤–ª—è—é release-—Ñ–∞–π–ª RedHat-based –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤–æ–≤..."
        echo "$NEW_PRETTY_NAME" | sudo tee "/etc/redhat-release" > /dev/null 2>/dev/null || true
        echo "$NEW_PRETTY_NAME" | sudo tee "/etc/centos-release" > /dev/null 2>/dev/null || true
        echo "$NEW_PRETTY_NAME" | sudo tee "/etc/fedora-release" > /dev/null 2>/dev/null || true
    fi
    
    if [ -f "/etc/debian_version" ]; then
        info "–û–±–Ω–æ–≤–ª—è—é –≤–µ—Ä—Å–∏—é Debian..."
        echo "$NEW_VERSION" | sudo tee "/etc/debian_version" > /dev/null
    fi
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤
check_permissions() {
    if [ "$EUID" -ne 0 ]; then
        error "–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç —Ç—Ä–µ–±—É–µ—Ç –ø—Ä–∞–≤ root. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å sudo:"
        echo "  sudo $0"
        exit 1
    fi
}

# –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
verify_changes() {
    echo
    success "–ò–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã!"
    echo
    info "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:"
    echo "====================="
    
    if [ -f "/etc/os-release" ]; then
        echo "--- /etc/os-release ---"
        grep -E "NAME|PRETTY_NAME|ID|VERSION" /etc/os-release | head -4
    fi
    
    if command -v hostnamectl >/dev/null 2>&1; then
        echo
        echo "--- hostnamectl ---"
        hostnamectl | grep -E "Operating System|Kernel"
    fi
    
    if command -v lsb_release >/dev/null 2>&1; then
        echo
        echo "--- lsb_release ---"
        lsb_release -a 2>/dev/null | grep -E "Description|Release" || true
    fi
    
    echo
    info "–ë—ç–∫–∞–ø—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤: $BACKUP_DIR"
    warning "–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å–∏—Å—Ç–µ–º—É –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤–æ –≤—Å–µ—Ö –ø—Ä–æ–≥—Ä–∞–º–º–∞—Ö"
}

# –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
main() {
    echo "üîÑ –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤–∞"
    echo "======================================================"
    
    check_permissions
    detect_distro
    find_distro_files
    get_user_input
    confirm_changes
    create_backups
    apply_changes
    verify_changes
}

# –ó–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞
main "$@"
